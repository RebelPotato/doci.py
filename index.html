<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <title>doci.py</title>
    <link rel="stylesheet" href="doci.css" type="text/css" />
  </head>
  <body>
    <div id="container">
      <div id="background"></div>
      <header>
        <h1 class="doc">doci.py</h1>
        <a
          href="https://your-url"
          class="github-corner"
          aria-label="View source on GitHub"
          ><svg
            width="80"
            height="80"
            viewBox="0 0 250 250"
            style="
              fill: #fefefe;
              color: #454545;
              position: absolute;
              top: 0;
              border: 0;
              right: 0;
            "
            aria-hidden="true"
          >
            <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z" />
            <path
              d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor"
              style="transform-origin: 130px 106px"
              class="octo-arm"
            />
            <path
              d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor"
              class="octo-body"
            /></svg></a
        ><style>
          .github-corner:hover .octo-arm {
            animation: octocat-wave 560ms ease-in-out;
          }
          @keyframes octocat-wave {
            0%,
            100% {
              transform: rotate(0);
            }
            20%,
            60% {
              transform: rotate(-25deg);
            }
            40%,
            80% {
              transform: rotate(10deg);
            }
          }
          @media (max-width: 500px) {
            .github-corner:hover .octo-arm {
              animation: none;
            }
            .github-corner .octo-arm {
              animation: octocat-wave 560ms ease-in-out;
            }
          }
        </style>
      </header>
      <section id="section-1">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-1">#</a>
          </div>
          <p>Doci is a quick and dirty tool for turning your script into documentation
that show explainations and code side by side, a.k.a. &quot;semi-<a href="https://en.wikipedia.org/wiki/Literate_programming">literate programming</a>&quot;.
It is simple and language agnostic.</p>
<p>This is very much a remix of <a href="https://github.com/pycco-docs/pycco">Pycco</a>,
which itself is a Python port of <a href="https://github.com/jashkenas/docco">Docco</a>,
the original lightweight literate programming tool.</p>
<p>[TODO: screenshot]</p>
<h2>Rationale</h2>
<p>The intent of a program is to be read by humans, not just executed by computers, etc...
But more importantly, <strong>LLMs write lots of comments</strong>, and a tool that turns them into documentation
would make them doubly useful!</p>
<p>By itself it's quite dumb and needs to rely on other tools. For example, <code>scripts/build.py</code>
watches <code>doci.py</code> for changes and reruns it automatically, which
is a very simple way to add file watching abilities to Doci.
(Maybe this is a good thing, because it means Doci is not trying to do everything by itself.)</p>
<p>It is also well-documented. Doci is &lt;300 lines of code plus comments and generates its own documentation,
so it should be quite easy to read, modify and extend.</p>
<h2>Usage</h2>
<p>To generate the documentation for itself, run:</p>
<pre><code class="language-bash">uv run doci.py
</code></pre>
<p>Does not support any other file yet... Working on it!</p>
<h2>Code</h2>

        </div>
        <div class="code"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">markdown_it</span><span class="w"> </span><span class="kn">import</span> <span class="n">MarkdownIt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mdit_py_plugins.footnote</span><span class="w"> </span><span class="kn">import</span> <span class="n">footnote_plugin</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pygments</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pygments.formatters</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pygments.lexers</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pystache</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>


</pre></div></div>
      </section>
      <section id="section-2">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-2">#</a>
          </div>
          <h3>Utility functions</h3>

        </div>
        <div class="code"><div class="highlight"><pre><span class="k">def</span><span class="w"> </span><span class="nf">running</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</pre></div></div>
      </section>
      <section id="section-3">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-3">#</a>
          </div>
          <p><code>running</code> calculates a running value from an iterable using a binary function <code>f</code>.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
        <span class="n">init</span> <span class="o">=</span> <span class="n">x</span> <span class="k">if</span> <span class="n">init</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">f</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">init</span>


<span class="k">def</span><span class="w"> </span><span class="nf">running_sum</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</pre></div></div>
      </section>
      <section id="section-4">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-4">#</a>
          </div>
          <p><code>running_sum</code> calculates the running sum of an iterable.</p>
<pre><code class="language-py">&gt;&gt; list(running_sum(range(5)))
[0, 1, 3, 6, 10, 15]

&gt;&gt; list(running_sum(range(5), 10))
[10, 11, 13, 16, 20, 25]
</code></pre>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="n">running</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">indent_size</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</pre></div></div>
      </section>
      <section id="section-5">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-5">#</a>
          </div>
          <p>A string's <code>indent_size</code> is the number of leading spaces.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">i</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">dedent</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</pre></div></div>
      </section>
      <section id="section-6">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-6">#</a>
          </div>
          <p><code>dedent</code> dedents a list of strings, removing the minimum leading whitespace
from all visible lines. Invisible lines (empty or whitespace-only)
are left unchanged.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">stripped</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
    <span class="n">min_indent</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
        <span class="p">(</span><span class="n">indent_size</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">stripped</span><span class="p">)</span> <span class="k">if</span> <span class="n">st</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">min_indent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">min_indent</span><span class="p">:]</span> <span class="k">if</span> <span class="n">st</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">line</span> <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">stripped</span><span class="p">)]</span>


</pre></div></div>
      </section>
      <section id="section-7">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-7">#</a>
          </div>
          <h3>Extracting chunks</h3>

        </div>
        <div class="code"><div class="highlight"><pre><span class="k">def</span><span class="w"> </span><span class="nf">parse_block_comment</span><span class="p">(</span>
    <span class="n">contents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">block_syms</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
</pre></div></div>
      </section>
      <section id="section-8">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-8">#</a>
          </div>
          <p><code>parse_block_comment</code> takes in a list of contents and parses out block comments.
<code>is_block_comment</code> is 0 for non-block-comment lines,
1 for a comment start line, and -1 for a comment end line.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">is_block_comment</span> <span class="o">=</span> <span class="p">[</span>
        <span class="mi">1</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">block_syms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">block_syms</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contents</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">block_syms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">block_syms</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</pre></div></div>
      </section>
      <section id="section-9">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-9">#</a>
          </div>
          <p>If the start and end of a block comment is one symbol,
every other symbol must be an end quote.</p>

        </div>
        <div class="code"><div class="highlight"><pre>        <span class="n">block_comment_locs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">is_block_comment</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">block_comment_locs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">is_block_comment</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

</pre></div></div>
      </section>
      <section id="section-10">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-10">#</a>
          </div>
          <p><code>level</code> is the nesting level of block comments.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="k">def</span><span class="w"> </span><span class="nf">next_level</span><span class="p">(</span><span class="n">seen</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</pre></div></div>
      </section>
      <section id="section-11">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-11">#</a>
          </div>
          <p>We don't handle recursive block_comments, because most languages don't support them.
If we do, we would need to increment <code>seen_quote</code> here.
Using <code>max</code>, this code works even if there are more end quotes than start quotes.</p>

        </div>
        <div class="code"><div class="highlight"><pre>        <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">seen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">seen</span>

    <span class="n">level</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">running</span><span class="p">(</span><span class="n">next_level</span><span class="p">,</span> <span class="n">is_block_comment</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">is_block_comment</span><span class="p">,</span> <span class="n">level</span>


<span class="k">def</span><span class="w"> </span><span class="nf">extract_chunks</span><span class="p">(</span>
    <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">comment_start</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">block_syms</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</pre></div></div>
      </section>
      <section id="section-12">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-12">#</a>
          </div>
          <p><code>extract_chunks</code> extracts doc and code chunks from a program. We return a list of chunks
and a list of booleans indicating whether each chunk is a doc chunk.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">lines</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">lc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>  <span class="c1"># line count</span>
</pre></div></div>
      </section>
      <section id="section-13">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-13">#</a>
          </div>
          <p>Contents are lines stripped from whitespaces and line breaks.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
    <span class="n">is_comment</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">comment_start</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">]</span>
    <span class="n">is_block_comment</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">parse_block_comment</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="n">block_syms</span><span class="p">)</span>

</pre></div></div>
      </section>
      <section id="section-14">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-14">#</a>
          </div>
          <p>Chunks are consecutive lines of the same type. Docs are chunks that are comments.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">is_doc</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">is_comment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">is_block_comment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
    <span class="p">]</span>
</pre></div></div>
      </section>
      <section id="section-15">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-15">#</a>
          </div>
          <p>As a result, chunks are always interspersed, which means
for each two doc chunks there is a code chunk in between, and vice versa.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">is_chunk_top</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">is_doc</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">is_doc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lc</span><span class="p">)]</span>
    <span class="n">chunk_top_loc</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">is_chunk_top</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="p">]</span>
    <span class="n">chunk_bottom_loc</span> <span class="o">=</span> <span class="n">chunk_top_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">lc</span><span class="p">]</span>

</pre></div></div>
      </section>
      <section id="section-16">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-16">#</a>
          </div>
          <p>Doc chunks are stripped of its starting symbols and whitespaces,
while code chunks are left as is.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="k">def</span><span class="w"> </span><span class="nf">strip</span><span class="p">(</span><span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_comment</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">contents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="n">comment_start</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">is_block_comment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</pre></div></div>
      </section>
      <section id="section-17">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-17">#</a>
          </div>
          <p>We ignore all block comment lines!</p>

        </div>
        <div class="code"><div class="highlight"><pre>            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_doc</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">contents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="n">chunk_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">strip</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">)]</span>
    <span class="n">chunk_type</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;doc&quot;</span> <span class="k">if</span> <span class="n">is_doc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;code&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chunk_top_loc</span><span class="p">]</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chunk_lines</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">chunk_top_loc</span><span class="p">,</span> <span class="n">chunk_bottom_loc</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">chunk_type</span><span class="p">,</span> <span class="n">chunks</span>


</pre></div></div>
      </section>
      <section id="section-18">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-18">#</a>
          </div>
          <h3>Formatting</h3>

        </div>
        <div class="code"><div class="highlight"><pre><span class="k">def</span><span class="w"> </span><span class="nf">highlight</span><span class="p">(</span><span class="n">code_chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">language</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">comment_start</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</pre></div></div>
      </section>
      <section id="section-19">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-19">#</a>
          </div>
          <p><code>highlight</code> turns a list of code chunks into HTML using pygments.
The code chunks are merged and passed pygments in one go,
which is more efficient than highlighting each chunk separately.
Magic divider text and html from pycco.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">divider_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">comment_start</span><span class="si">}</span><span class="s2">DIVIDER</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">divider_html</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">rf</span><span class="s1">&#39;\n&lt;span class=&quot;c[1]?&quot;&gt;</span><span class="si">{</span><span class="n">comment_start</span><span class="si">}</span><span class="s1">DIVIDER&lt;/span&gt;\n&#39;</span><span class="p">)</span>
    <span class="n">lexer</span> <span class="o">=</span> <span class="n">pygments</span><span class="o">.</span><span class="n">lexers</span><span class="o">.</span><span class="n">get_lexer_by_name</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>

</pre></div></div>
      </section>
      <section id="section-20">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-20">#</a>
          </div>
          <p>To do this, we join all code chunks into a single program
with a piece of divider text in between,</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">joined_code</span> <span class="o">=</span> <span class="n">divider_text</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code_chunks</span><span class="p">)</span>
</pre></div></div>
      </section>
      <section id="section-21">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-21">#</a>
          </div>
          <p>highlight the whole thing using pygments,</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">html_formatter</span> <span class="o">=</span> <span class="n">pygments</span><span class="o">.</span><span class="n">formatters</span><span class="o">.</span><span class="n">get_formatter_by_name</span><span class="p">(</span><span class="s2">&quot;html&quot;</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pygments</span><span class="o">.</span><span class="n">highlight</span><span class="p">(</span><span class="n">joined_code</span><span class="p">,</span> <span class="n">lexer</span><span class="p">,</span> <span class="n">html_formatter</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/pre&gt;&lt;/div&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div></div>
      </section>
      <section id="section-22">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-22">#</a>
          </div>
          <p>then split it into html to get the html for each code section.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s1">&#39;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">&lt;/pre&gt;&lt;/div&gt;&#39;</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">divider_html</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
    <span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">to_markdown</span><span class="p">(</span><span class="n">chunk_type</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">language</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</pre></div></div>
      </section>
      <section id="section-23">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-23">#</a>
          </div>
          <p><code>to_markdown</code> convert chunks to markdown.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">md</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">chunk_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;doc&quot;</span><span class="p">:</span>
</pre></div></div>
      </section>
      <section id="section-24">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-24">#</a>
          </div>
          <p>Doc chunks are dedented.</p>

        </div>
        <div class="code"><div class="highlight"><pre>            <span class="n">md</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dedent</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">True</span><span class="p">))))</span>
        <span class="k">else</span><span class="p">:</span>
</pre></div></div>
      </section>
      <section id="section-25">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-25">#</a>
          </div>
          <p>Code chunks are stripped of trailing spaces and newlines in markdown.</p>

        </div>
        <div class="code"><div class="highlight"><pre>            <span class="n">stripped</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">stripped</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">md</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;```</span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">chunk</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">```</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">to_html</span><span class="p">(</span>
    <span class="n">chunk_type</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">language</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</pre></div></div>
      </section>
      <section id="section-26">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-26">#</a>
          </div>
          <p><code>to_html</code> convert chunks to HTML.
Code is parsed using pygments.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">code_locs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunk_type</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">]</span>
    <span class="n">code_chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">code_locs</span><span class="p">]</span>
    <span class="n">code_html</span> <span class="o">=</span> <span class="n">highlight</span><span class="p">(</span><span class="n">code_chunks</span><span class="p">,</span> <span class="n">language</span><span class="p">,</span> <span class="s2">&quot;#&quot;</span><span class="p">)</span>

</pre></div></div>
      </section>
      <section id="section-27">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-27">#</a>
          </div>
          <p>Docs are parsed using markdown-it according to the commonmark spec
with tables and footnotes enabled.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">docs_locs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunk_type</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;doc&quot;</span><span class="p">]</span>
    <span class="n">docs_chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">docs_locs</span><span class="p">]</span>
    <span class="n">md</span> <span class="o">=</span> <span class="n">MarkdownIt</span><span class="p">(</span><span class="s2">&quot;commonmark&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">footnote_plugin</span><span class="p">)</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">)</span>
    <span class="n">docs_html</span> <span class="o">=</span> <span class="p">[</span><span class="n">md</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">docs_chunks</span><span class="p">]</span>

    <span class="n">html</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">code_locs</span><span class="p">,</span> <span class="n">code_html</span><span class="p">):</span>
        <span class="n">html</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">docs_locs</span><span class="p">,</span> <span class="n">docs_html</span><span class="p">):</span>
        <span class="n">html</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
</pre></div></div>
      </section>
      <section id="section-28">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-28">#</a>
          </div>
          <p>Pair the doc and code chunks together.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">sections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">doc</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">html</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">chunk_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;doc&quot;</span> <span class="ow">and</span> <span class="n">doc</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">doc</span><span class="p">,</span> <span class="n">code</span><span class="p">))</span>
            <span class="n">doc</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="k">elif</span> <span class="n">chunk_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span> <span class="ow">and</span> <span class="n">code</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">doc</span><span class="p">,</span> <span class="n">code</span><span class="p">))</span>
            <span class="n">doc</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="n">doc</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="k">if</span> <span class="n">chunk_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;doc&quot;</span> <span class="k">else</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">doc</span><span class="p">,</span> <span class="n">code</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pystache</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
        <span class="n">template</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
            <span class="s2">&quot;sections&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;num&quot;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;doc&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">,</span>
                    <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>
            <span class="p">],</span>
        <span class="p">},</span>
    <span class="p">)</span>


</pre></div></div>
      </section>
      <section id="section-29">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-29">#</a>
          </div>
          <h3>Command line interface</h3>

        </div>
        <div class="code"><div class="highlight"><pre><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;doci.py&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">chunk_type</span><span class="p">,</span> <span class="n">chunks</span> <span class="o">=</span> <span class="n">extract_chunks</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">))</span>
</pre></div></div>
      </section>
      <section id="section-30">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-30">#</a>
          </div>
          <p>Hardcoded to generate README.md and index.html for now.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;README.md&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# doci.py</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">to_markdown</span><span class="p">(</span><span class="n">chunk_type</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="s2">&quot;py&quot;</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;template.html&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;index.html&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">to_html</span><span class="p">(</span><span class="n">chunk_type</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="s2">&quot;py&quot;</span><span class="p">,</span> <span class="s2">&quot;doci.py&quot;</span><span class="p">,</span> <span class="n">template</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>

</pre></div></div>
      </section>
    </div>
  </body>
</html>
