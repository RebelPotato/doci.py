<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <title>dok.py</title>
    <link rel="stylesheet" href="doci.css" type="text/css" />
  </head>
  <body>
    <div id="container">
      <div id="background"></div>
      <header>
        <h1 class="doc">dok.py</h1>
        <a
          href="https://github.com/RebelPotato/doci.py"
          class="github-corner"
          aria-label="View source on GitHub"
          ><svg
            width="80"
            height="80"
            viewBox="0 0 250 250"
            style="
              fill: #fefefe;
              color: #454545;
              position: absolute;
              top: 0;
              border: 0;
              right: 0;
            "
            aria-hidden="true"
          >
            <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z" />
            <path
              d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor"
              style="transform-origin: 130px 106px"
              class="octo-arm"
            />
            <path
              d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor"
              class="octo-body"
            /></svg></a
        ><style>
          .github-corner:hover .octo-arm {
            animation: octocat-wave 560ms ease-in-out;
          }
          @keyframes octocat-wave {
            0%,
            100% {
              transform: rotate(0);
            }
            20%,
            60% {
              transform: rotate(-25deg);
            }
            40%,
            80% {
              transform: rotate(10deg);
            }
          }
          @media (max-width: 500px) {
            .github-corner:hover .octo-arm {
              animation: none;
            }
            .github-corner .octo-arm {
              animation: octocat-wave 560ms ease-in-out;
            }
          }
        </style>
      </header>
      <section id="section-1">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-1">#</a>
          </div>
          <p><a href="https://rebelpotato.github.io/dok.py/">Dok</a> is a quick and dirty tool for turning your script into documentation
that show explainations and code side by side, a.k.a. &quot;semi-<a href="https://en.wikipedia.org/wiki/Literate_programming">literate programming</a>&quot;.
It is simple and language agnostic.</p>
<p>This is very much a remix of <a href="https://github.com/pycco-docs/pycco">Pycco</a>,
which itself is a Python port of <a href="https://github.com/jashkenas/docco">Docco</a>,
the original lightweight literate programming tool. Compared to Pycco and Docco, Dok:</p>
<ul>
<li>is simpler and better documented (in my opinion)</li>
<li>processes most languages, by virtue of being dumb</li>
<li>has a customizable template that works on mobile out of the box</li>
</ul>
<p>Dok is written literately and generates its own documentation,
so it should be quite easy to understand, modify and extend.</p>
<p><img src="./assets/screenshot.png" alt="Screenshot of Dok output" /></p>

        </div>
        <div class="code"><div class="highlight"><pre><span></span></pre></div></div>
      </section>
      <section id="section-2">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-2">#</a>
          </div>
          <h2>Rationale</h2>
<blockquote>
<p>&quot;Programs are meant to be read by humans and only incidentally for computers to execute.&quot;</p>
<p>-- Donald Knuth</p>
</blockquote>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Literate_programming">Literate programming</a> is
underappreciated and underused, in part because existing tools are quite heavyweight.</li>
<li>Most major languages support forward definitions, so you don't need to
weave your code using an external tool. Your compiler can do it just fine.</li>
<li>Debugging can be a pain if you don't know where your code is going to be.</li>
<li><strong>LLMs write lots of comments</strong>, so a tool that turns comments into documentation
would make LLMs doubly useful!</li>
</ul>
<p>So like <a href="https://github.com/pycco-docs/pycco">Pycco</a> &amp; <a href="https://github.com/jashkenas/docco">Docco</a>,
Dok just extracts your comments into prose, stuff your code in code blocks
and calls it a day.</p>

        </div>
        <div class="code"><div class="highlight"><pre>
</pre></div></div>
      </section>
      <section id="section-3">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-3">#</a>
          </div>
          <h2>Usage</h2>
<p>Clone this repository. Dok's own documentation is generated by running</p>
<pre><code class="language-bash">uv run dok.py -m README.md -H index.html -c '#' -b '&quot;&quot;&quot;' '&quot;&quot;&quot;' dok.py
</code></pre>
<p>or in powershell:</p>
<pre><code class="language-powershell"># note the horrendous quoting
uv run dok.py -m README.md -H index.html -c '#' -b '&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;' '&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;' dok.py
</code></pre>
<p>This tells Dok to read its own source <code>dok.py</code>, treat <code>#</code> as comment start
and <code>&quot;&quot;&quot;</code> as block comment delimiters, and generate <code>README.md</code> and <code>index.html</code>
from it, given that the default html template <code>template.html</code> exists in the same folder.</p>
<p>For other languages, use <code>-l(--language)</code> to specify the language name for syntax highlighting,
and change the comment and block comment symbols accordingly.</p>
<p>If you're using javascript for instance:</p>
<pre><code class="language-bash">uv run dok.py -m -H -c '//' -b '/*' '*/' script.js
</code></pre>
<p>will create <code>script.js.md</code> and <code>script.js.html</code> from <code>script.js</code>,</p>
<p>By itself it's quite dumb and needs to rely on other tools. For example, <code>scripts/build.py</code>
watches <code>dok.py</code> for changes and reruns it automatically, which
is a very simple way to add file watching abilities to Dok.
(Maybe this is a good thing, Dok is not trying to do everything by itself ;)</p>

        </div>
        <div class="code"><div class="highlight"><pre>
</pre></div></div>
      </section>
      <section id="section-4">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-4">#</a>
          </div>
          <h2>Dependencies</h2>

        </div>
        <div class="code"><div class="highlight"><pre><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">markdown_it</span><span class="w"> </span><span class="kn">import</span> <span class="n">MarkdownIt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mdit_py_plugins.footnote</span><span class="w"> </span><span class="kn">import</span> <span class="n">footnote_plugin</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pygments</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pygments.formatters</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pygments.lexers</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pystache</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

</pre></div></div>
      </section>
      <section id="section-5">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-5">#</a>
          </div>
          <h2>Terminology</h2>
<p>The following terms are used throughout the code, and are important to understand how Dok works:</p>
<ul>
<li>line: a string that contains only one newline character <code>\n</code>, which should be the string's last character.</li>
<li>chunk: consecutive lines in a list of lines. We can represent it as a list of lines ...</li>
</ul>

        </div>
        <div class="code"><div class="highlight"><pre><span class="n">SOME_LINE</span> <span class="o">=</span> <span class="s2">&quot;This is a line.</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="n">SOME_CHUNK</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;This is not a line,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;But a chunk.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;It can be split into three lines.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">ANOTHER_CHUNK</span> <span class="o">=</span> <span class="n">SOME_CHUNK</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</pre></div></div>
      </section>
      <section id="section-6">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-6">#</a>
          </div>
          <p>But an index-offset tuple works as well.</p>

        </div>
        <div class="code"><div class="highlight"><pre><span class="n">A_THIRD_CHUNK</span> <span class="o">=</span> <span class="p">(</span><span class="n">SOME_CHUNK</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div></div>
      </section>
      <section id="section-7">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-7">#</a>
          </div>
          <ul>
<li>content: a line stripped of leading and trailing whitespaces and line breaks.</li>
</ul>

        </div>
        <div class="code"><div class="highlight"><pre><span class="n">SOME_CONTENT</span> <span class="o">=</span> <span class="n">SOME_LINE</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">SOME_CONTENT</span> <span class="o">==</span> <span class="s2">&quot;This is a line.&quot;</span>
</pre></div></div>
      </section>
      <section id="section-8">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-8">#</a>
          </div>
          <ul>
<li>comment: a line whose content starts with a comment symbol, e.g. <code>#</code> in Python.</li>
</ul>

        </div>
        <div class="code"><div class="highlight"><pre><span class="n">SOME_COMMENT</span> <span class="o">=</span> <span class="s2">&quot;    # This is a comment.</span><span class="se">\n</span><span class="s2">&quot;</span>
</pre></div></div>
      </section>
      <section id="section-9">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-9">#</a>
          </div>
          <ul>
<li>block comment boundary: a line that starts or ends a block comment.</li>
</ul>
<p>Its content either starts with a block comment start symbol,</p>

        </div>
        <div class="code"><div class="highlight"><pre><span class="n">SOME_BLOCK_START</span> <span class="o">=</span> <span class="s1">&#39;    &quot;&quot;&quot; Block comment start.</span><span class="se">\n</span><span class="s1">&#39;</span>
</pre></div></div>
      </section>
      <section id="section-10">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-10">#</a>
          </div>
          <p>ends with a block comment end symbol,</p>

        </div>
        <div class="code"><div class="highlight"><pre><span class="n">SOME_BLOCK_END</span> <span class="o">=</span> <span class="s1">&#39;    Block comment end. &quot;&quot;&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
</pre></div></div>
      </section>
      <section id="section-11">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-11">#</a>
          </div>
          <p>or both. (These don't show up in the output for now...)</p>

        </div>
        <div class="code"><div class="highlight"><pre><span class="n">SOME_BLOCK_BOTH</span> <span class="o">=</span> <span class="s1">&#39;    &quot;&quot;&quot; Block comment start and end. &quot;&quot;&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
</pre></div></div>
      </section>
      <section id="section-12">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-12">#</a>
          </div>
          <ul>
<li>block comment: a line surrounded by block comment boundaries.</li>
</ul>
<pre><code class="language-python">&quot;&quot;&quot; This line is a block comment boundary, not a block comment,
but this line is.
&quot;&quot;&quot;
</code></pre>

        </div>
        <div class="code"><div class="highlight"><pre>

</pre></div></div>
      </section>
      <section id="section-13">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-13">#</a>
          </div>
          <h2>Main</h2>

        </div>
        <div class="code"><div class="highlight"><pre><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
</pre></div></div>
      </section>
      <section id="section-14">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-14">#</a>
          </div>
          <p><code>main</code> is Dok's main function. Conceptually, Dok is quite simple.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
</pre></div></div>
      </section>
      <section id="section-15">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-15">#</a>
          </div>
          <p>First, it reads a source file, separates it into lines,</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">file</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</pre></div></div>
      </section>
      <section id="section-16">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-16">#</a>
          </div>
          <p>then extracts chunks of code and documentation from the lines.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">comment_sym</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">comment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div></div>
      </section>
      <section id="section-17">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-17">#</a>
          </div>
          <p>Block comments are optional.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">block_syms</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">block</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">block</span> <span class="k">else</span> <span class="kc">None</span>
</pre></div></div>
      </section>
      <section id="section-18">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-18">#</a>
          </div>
          <p>Chunks that only contain comments and block comments are labeled as documentation,
and all the rest are code chunks.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">chunk_type</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">chunk_locs</span> <span class="o">=</span> <span class="n">extract_chunks</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">comment_sym</span><span class="p">,</span> <span class="n">block_syms</span><span class="p">)</span>

</pre></div></div>
      </section>
      <section id="section-19">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-19">#</a>
          </div>
          <p>After that, it formats the chunks and produce markdown and/or HTML.
It uses the file's extension to determine the language if not specified.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">lang</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">language</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">language</span> <span class="k">else</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">markdown</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">markdown_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">markdown</span> <span class="ow">or</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.md&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">markdown_file</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# </span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">to_markdown</span><span class="p">(</span><span class="n">chunk_type</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">lang</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">html</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</pre></div></div>
      </section>
      <section id="section-20">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-20">#</a>
          </div>
          <p>Formatting HTML needs a template.</p>

        </div>
        <div class="code"><div class="highlight"><pre>        <span class="n">template_file</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">template</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">template</span>
            <span class="k">else</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;template.html&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">template_file</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">html_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">html</span> <span class="ow">or</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.html&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">html_file</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">to_html</span><span class="p">(</span>
                    <span class="n">chunk_type</span><span class="o">=</span><span class="n">chunk_type</span><span class="p">,</span>
                    <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
                    <span class="n">chunk_locs</span><span class="o">=</span><span class="n">chunk_locs</span><span class="p">,</span>
                    <span class="n">language</span><span class="o">=</span><span class="n">lang</span><span class="p">,</span>
                    <span class="n">comment_sym</span><span class="o">=</span><span class="n">comment_sym</span><span class="p">,</span>
                    <span class="n">file_name</span><span class="o">=</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">template</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
</pre></div></div>
      </section>
      <section id="section-21">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-21">#</a>
          </div>
          <p>And that's it!</p>

        </div>
        <div class="code"><div class="highlight"><pre>

</pre></div></div>
      </section>
      <section id="section-22">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-22">#</a>
          </div>
          <h2>Extracting chunks</h2>

        </div>
        <div class="code"><div class="highlight"><pre><span class="k">def</span><span class="w"> </span><span class="nf">extract_chunks</span><span class="p">(</span>
    <span class="n">lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">comment_sym</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">block_syms</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
</pre></div></div>
      </section>
      <section id="section-23">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-23">#</a>
          </div>
          <p><code>extract_chunks</code> extracts doc and code chunks from a program. We return a list of chunks,
a list of strings indicating each chunk's type (doc or code),
and a list of locations of the top of each chunk.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">lc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>  <span class="c1"># line count</span>
</pre></div></div>
      </section>
      <section id="section-24">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-24">#</a>
          </div>
          <p>Contents are lines stripped from leading and trailing whitespaces and line breaks.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
    <span class="n">is_comment</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">comment_sym</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">]</span>
    <span class="n">is_block_comment</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">parse_block_comment</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="n">block_syms</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">block_syms</span>
        <span class="k">else</span> <span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">lc</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">lc</span><span class="p">)</span>
    <span class="p">)</span>

</pre></div></div>
      </section>
      <section id="section-25">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-25">#</a>
          </div>
          <p>Chunks are consecutive lines of the same type. Docs are chunks that are comments.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">is_doc</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">is_comment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">is_block_comment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
    <span class="p">]</span>
</pre></div></div>
      </section>
      <section id="section-26">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-26">#</a>
          </div>
          <p>As a result, chunks are always interspersed, which means
for each two doc chunks there is a code chunk in between, and vice versa.
So changes in chunk type marks the start of a new chunk.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">is_chunk_top</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">is_doc</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">is_doc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lc</span><span class="p">)]</span>
    <span class="n">chunk_top_loc</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">is_chunk_top</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="p">]</span>
    <span class="n">chunk_bottom_loc</span> <span class="o">=</span> <span class="n">chunk_top_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">lc</span><span class="p">]</span>

</pre></div></div>
      </section>
      <section id="section-27">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-27">#</a>
          </div>
          <p>Doc chunks are stripped of its starting symbols and whitespaces,
while code chunks are left as is.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="k">def</span><span class="w"> </span><span class="nf">strip</span><span class="p">(</span><span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_comment</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">contents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="n">comment_sym</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">is_block_comment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</pre></div></div>
      </section>
      <section id="section-28">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-28">#</a>
          </div>
          <p>We ignore all block comment lines!</p>

        </div>
        <div class="code"><div class="highlight"><pre>            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_doc</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">contents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="n">chunk_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">strip</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">)]</span>
    <span class="n">chunk_type</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;doc&quot;</span> <span class="k">if</span> <span class="n">is_doc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;code&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chunk_top_loc</span><span class="p">]</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">chunk_lines</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">chunk_top_loc</span><span class="p">,</span> <span class="n">chunk_bottom_loc</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">chunk_type</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">chunk_top_loc</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_block_comment</span><span class="p">(</span>
    <span class="n">contents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">block_syms</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
</pre></div></div>
      </section>
      <section id="section-29">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-29">#</a>
          </div>
          <p><code>parse_block_comment</code> takes in a list of contents and parses out block comments.
<code>is_block_comment</code> is 0 for non-block-comment lines,
1 for a comment start line, and -1 for a comment end line.
TODO: handle single-line block comments.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">is_block_comment</span> <span class="o">=</span> <span class="p">[</span>
        <span class="mi">1</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">block_syms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">block_syms</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contents</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">block_syms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">block_syms</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</pre></div></div>
      </section>
      <section id="section-30">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-30">#</a>
          </div>
          <p>If the start and end of a block comment is one symbol,
every other symbol must be an end quote.</p>

        </div>
        <div class="code"><div class="highlight"><pre>        <span class="n">block_comment_locs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">is_block_comment</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">block_comment_locs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">is_block_comment</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

</pre></div></div>
      </section>
      <section id="section-31">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-31">#</a>
          </div>
          <p><code>level</code> is the nesting level of block comments.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="k">def</span><span class="w"> </span><span class="nf">next_level</span><span class="p">(</span><span class="n">seen</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</pre></div></div>
      </section>
      <section id="section-32">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-32">#</a>
          </div>
          <p>We don't handle recursive block_comments, because most languages don't support them.
If we do, we would need to increment <code>seen_quote</code> here.
Using <code>max</code>, this code works even if there are more end quotes than start quotes.</p>

        </div>
        <div class="code"><div class="highlight"><pre>        <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">seen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">seen</span>

    <span class="n">level</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">running</span><span class="p">(</span><span class="n">next_level</span><span class="p">,</span> <span class="n">is_block_comment</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">is_block_comment</span><span class="p">,</span> <span class="n">level</span>


</pre></div></div>
      </section>
      <section id="section-33">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-33">#</a>
          </div>
          <h2>Formatting</h2>

        </div>
        <div class="code"><div class="highlight"><pre><span class="k">def</span><span class="w"> </span><span class="nf">to_markdown</span><span class="p">(</span><span class="n">chunk_type</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">language</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</pre></div></div>
      </section>
      <section id="section-34">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-34">#</a>
          </div>
          <p><code>to_markdown</code> convert chunks to markdown. It is quite simple!</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">md</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">chunk_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;doc&quot;</span><span class="p">:</span>
</pre></div></div>
      </section>
      <section id="section-35">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-35">#</a>
          </div>
          <p>For markdown, we dedent doc chunks for better readability.</p>

        </div>
        <div class="code"><div class="highlight"><pre>            <span class="n">md</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dedent</span><span class="p">(</span><span class="n">chunk</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
</pre></div></div>
      </section>
      <section id="section-36">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-36">#</a>
          </div>
          <p>We strip trailing spaces and newlines off code chunks, so that
each code block ends with actual code instead of empty lines.</p>

        </div>
        <div class="code"><div class="highlight"><pre>            <span class="n">stripped</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">stripped</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">md</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;```</span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">stripped</span><span class="si">}</span><span class="se">\n</span><span class="s2">```</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>


</pre></div></div>
      </section>
      <section id="section-37">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-37">#</a>
          </div>
          <p>HTML's more tricky though, because it needs styling and formatting.
We use pygments for code highlighting and markdown-it for markdown formatting.
For markdown, we use the commonmark spec with tables and footnotes enabled.</p>

        </div>
        <div class="code"><div class="highlight"><pre><span class="n">HTML_FORMATTER</span> <span class="o">=</span> <span class="n">pygments</span><span class="o">.</span><span class="n">formatters</span><span class="o">.</span><span class="n">HtmlFormatter</span><span class="p">()</span>
<span class="n">MD</span> <span class="o">=</span> <span class="n">MarkdownIt</span><span class="p">(</span><span class="s2">&quot;commonmark&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">footnote_plugin</span><span class="p">)</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">to_html</span><span class="p">(</span>
    <span class="n">chunk_type</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">chunk_locs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="n">language</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">comment_sym</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</pre></div></div>
      </section>
      <section id="section-38">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-38">#</a>
          </div>
          <p><code>to_html</code> convert chunks to HTML. This function is quite big for now,
need to break it down into smaller functions soon.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">code_locs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunk_type</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">]</span>
    <span class="n">code_html</span> <span class="o">=</span> <span class="n">highlight</span><span class="p">(</span>
        <span class="n">code_chunks</span><span class="o">=</span><span class="p">[</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">code_locs</span><span class="p">],</span>
        <span class="n">chunk_locs</span><span class="o">=</span><span class="p">[</span><span class="n">chunk_locs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">code_locs</span><span class="p">],</span>
        <span class="n">language</span><span class="o">=</span><span class="n">language</span><span class="p">,</span>
        <span class="n">comment_sym</span><span class="o">=</span><span class="n">comment_sym</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">docs_locs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunk_type</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;doc&quot;</span><span class="p">]</span>
    <span class="n">docs_html</span> <span class="o">=</span> <span class="p">[</span><span class="n">MD</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">docs_locs</span><span class="p">]</span>

</pre></div></div>
      </section>
      <section id="section-39">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-39">#</a>
          </div>
          <p>Join the code and doc html strings together.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">html</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">code_locs</span><span class="p">,</span> <span class="n">code_html</span><span class="p">):</span>
        <span class="n">html</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">docs_locs</span><span class="p">,</span> <span class="n">docs_html</span><span class="p">):</span>
        <span class="n">html</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
</pre></div></div>
      </section>
      <section id="section-40">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-40">#</a>
          </div>
          <p>This pairing is set up, so that two consecutive chunks of the same type
remain together in the output view.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">sections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">doc</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">html</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">chunk_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;doc&quot;</span> <span class="ow">and</span> <span class="n">doc</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">doc</span><span class="p">,</span> <span class="n">code</span><span class="p">))</span>
            <span class="n">doc</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="k">elif</span> <span class="n">chunk_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span> <span class="ow">and</span> <span class="n">code</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">doc</span><span class="p">,</span> <span class="n">code</span><span class="p">))</span>
            <span class="n">doc</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="n">doc</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="k">if</span> <span class="n">chunk_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;doc&quot;</span> <span class="k">else</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">doc</span><span class="p">,</span> <span class="n">code</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pystache</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
        <span class="n">template</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
            <span class="s2">&quot;sections&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;num&quot;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;doc&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">,</span>
                    <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>
            <span class="p">],</span>
        <span class="p">},</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">highlight</span><span class="p">(</span>
    <span class="n">code_chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">chunk_locs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">language</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">comment_sym</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</pre></div></div>
      </section>
      <section id="section-41">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-41">#</a>
          </div>
          <p><code>highlight</code> turns a list of code chunks into HTML using pygments.
The code chunks are merged and passed to pygments in one go,
because pygment can't highlight partial code.
Magic divider text and html adapted from pycco.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">divider_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">comment_sym</span><span class="si">}</span><span class="s2">DIVIDER</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">divider_html</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">rf</span><span class="s1">&#39;&lt;span class=&quot;c[1]?&quot;&gt;</span><span class="si">{</span><span class="n">comment_sym</span><span class="si">}</span><span class="s1">DIVIDER&lt;/span&gt;\n&#39;</span><span class="p">)</span>
</pre></div></div>
      </section>
      <section id="section-42">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-42">#</a>
          </div>
          <p>To do this, we join all code chunks into a single program
with a piece of divider text in between,</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">joined_code</span> <span class="o">=</span> <span class="n">divider_text</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">code_chunks</span><span class="p">))</span>
</pre></div></div>
      </section>
      <section id="section-43">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-43">#</a>
          </div>
          <p>highlight the whole thing using pygments,
(TODO: map line numbers)</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">lexer</span> <span class="o">=</span> <span class="n">pygments</span><span class="o">.</span><span class="n">lexers</span><span class="o">.</span><span class="n">get_lexer_by_name</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pygments</span><span class="o">.</span><span class="n">highlight</span><span class="p">(</span><span class="n">joined_code</span><span class="p">,</span> <span class="n">lexer</span><span class="p">,</span> <span class="n">HTML_FORMATTER</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;/pre&gt;&lt;/div&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div></div>
      </section>
      <section id="section-44">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-44">#</a>
          </div>
          <p>then split it into html to get the html for each code section.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">htmls</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s1">&#39;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">&lt;/pre&gt;&lt;/div&gt;&#39;</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">divider_html</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">htmls</span>


</pre></div></div>
      </section>
      <section id="section-45">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-45">#</a>
          </div>
          <h2>Appendix</h2>
<h3>Command line interface</h3>

        </div>
        <div class="code"><div class="highlight"><pre><span class="k">def</span><span class="w"> </span><span class="nf">parse_args</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;A simple literate programming tool.&quot;</span><span class="p">)</span>
</pre></div></div>
      </section>
      <section id="section-46">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-46">#</a>
          </div>
          <p>TODO: add rationale for the arguments</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-m&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--markdown&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span>
        <span class="n">const</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;generate markdown output&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-H&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--html&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span>
        <span class="n">const</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;generate HTML output&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--template&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span>
        <span class="n">const</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;HTML template file&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-l&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--language&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;language name (for syntax highlighting)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--comment&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;comment start symbol (default: &#39;#&#39;)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-b&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--block&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</pre></div></div>
      </section>
      <section id="section-47">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-47">#</a>
          </div>
          <p>Some languages don't have block comments, so we default to None.</p>

        </div>
        <div class="code"><div class="highlight"><pre>        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;block comment start and end symbols (default: None)&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;file&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">FileType</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span>
        <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;source file to process&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>


</pre></div></div>
      </section>
      <section id="section-48">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-48">#</a>
          </div>
          <h3>Utility functions</h3>

        </div>
        <div class="code"><div class="highlight"><pre><span class="k">def</span><span class="w"> </span><span class="nf">running</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</pre></div></div>
      </section>
      <section id="section-49">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-49">#</a>
          </div>
          <p><code>running</code> calculates a running value from an iterable using a binary function <code>f</code>.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
        <span class="n">init</span> <span class="o">=</span> <span class="n">x</span> <span class="k">if</span> <span class="n">init</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">f</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">init</span>


<span class="k">def</span><span class="w"> </span><span class="nf">running_sum</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</pre></div></div>
      </section>
      <section id="section-50">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-50">#</a>
          </div>
          <p><code>running_sum</code> calculates the running sum of an iterable.</p>
<pre><code class="language-py">&gt;&gt;&gt; list(running_sum(range(5)))
[0, 1, 3, 6, 10]

&gt;&gt;&gt; list(running_sum(range(5), 10))
[10, 11, 13, 16, 20]

</code></pre>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="n">running</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">leading_count</span><span class="p">(</span><span class="n">char</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</pre></div></div>
      </section>
      <section id="section-51">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-51">#</a>
          </div>
          <p><code>leading_count</code> counts the number of leading characters <code>char</code> in a string <code>s</code>.</p>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">char</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">i</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">dedent</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</pre></div></div>
      </section>
      <section id="section-52">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-52">#</a>
          </div>
          <p><code>dedent</code> dedents a list of strings, removing the minimum leading whitespace
from all visible lines. Invisible lines (empty or whitespace-only)
are left unchanged.</p>
<pre><code class="language-py">&gt;&gt;&gt; dedent([&quot;    4 spaces&quot;, &quot;  2 spaces&quot;, &quot;&quot;, &quot;   3 spaces&quot;])
['  4 spaces', '2 spaces', '', ' 3 spaces']

</code></pre>

        </div>
        <div class="code"><div class="highlight"><pre>    <span class="n">stripped</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
    <span class="n">min_indent</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
        <span class="p">(</span><span class="n">leading_count</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">stripped</span><span class="p">)</span> <span class="k">if</span> <span class="n">st</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">min_indent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">min_indent</span><span class="p">:]</span> <span class="k">if</span> <span class="n">st</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">line</span> <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">stripped</span><span class="p">)]</span>


</pre></div></div>
      </section>
      <section id="section-53">
        <div class="doc">
          <div class="octowrap">
            <a class="octothorpe" href="#section-53">#</a>
          </div>
          <h2>Finally, start the script</h2>

        </div>
        <div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div></div>
      </section>
    </div>
  </body>
</html>
